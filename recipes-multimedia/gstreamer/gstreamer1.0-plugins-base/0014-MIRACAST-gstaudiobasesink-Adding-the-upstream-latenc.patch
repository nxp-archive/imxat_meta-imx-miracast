From d1905991595341151a5d7570d0047bcd36be42fb Mon Sep 17 00:00:00 2001
From: Matthieu Vanin <matthieu.vanin@nxp.com>
Date: Wed, 29 Mar 2017 16:15:19 -0400
Subject: [PATCH 2/2] [MIRACAST] gstaudiobasesink: Adding the upstream latency
 to  the sync-offset calculation

---
 gst-libs/gst/audio/gstaudiobasesink.c | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/gst-libs/gst/audio/gstaudiobasesink.c b/gst-libs/gst/audio/gstaudiobasesink.c
index 2f6e6f0..fed78d5 100755
--- a/gst-libs/gst/audio/gstaudiobasesink.c
+++ b/gst-libs/gst/audio/gstaudiobasesink.c
@@ -1823,7 +1823,7 @@ static GstFlowReturn
 gst_audio_base_sink_render (GstBaseSink * bsink, GstBuffer * buf)
 {
   GstClockTime time, stop, render_start, render_stop, sample_offset;
-  GstClockTimeDiff sync_offset, ts_offset;
+  GstClockTimeDiff sync_offset, ts_offset,g_us_latency;
   GstAudioBaseSinkClass *bclass;
   GstAudioBaseSink *sink;
   GstAudioRingBuffer *ringbuf;
@@ -1950,11 +1950,12 @@ gst_audio_base_sink_render (GstBaseSink * bsink, GstBuffer * buf)
   latency = gst_base_sink_get_latency (bsink);
   ts_offset = gst_base_sink_get_ts_offset (bsink);
   render_delay = gst_base_sink_get_render_delay (bsink);
-  sync_offset = ts_offset - render_delay + latency;
+  g_us_latency = gst_base_sink_get_upstream_latency (bsink);
+  sync_offset = g_us_latency + ts_offset - render_delay + latency;
 
   GST_DEBUG_OBJECT (sink,
-      "sync-offset %" GST_STIME_FORMAT ", render-delay %" GST_TIME_FORMAT
-      ", ts-offset %" GST_STIME_FORMAT, GST_STIME_ARGS (sync_offset),
+      "sync-offset %" G_GINT64_FORMAT "g_us_latency %" G_GINT64_FORMAT ", render-delay %" GST_TIME_FORMAT
+      ", ts-offset %" G_GINT64_FORMAT, sync_offset, g_us_latency, 
       GST_TIME_ARGS (render_delay), GST_STIME_ARGS (ts_offset));
 
   /* compensate for ts-offset and device-delay when negative we need to
-- 
1.9.1

